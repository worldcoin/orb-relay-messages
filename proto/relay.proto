syntax = "proto3";

package relay;

import "config/backend.proto";
import "config/orb.proto";
import "self_serve/app.proto";
import "self_serve/orb.proto";

enum EntityType {
  ENTITY_TYPE_UNSPECIFIED = 0;
  APP = 1;
  ORB = 2;
  SERVICE = 3;
}

message Entity {
  string id = 1;
  EntityType entity_type = 2;
}

// Service Definitions
service OrbService {
  rpc OrbConnect(stream RelayMessage) returns (stream RelayMessage);
}

service AppService {
  rpc AppConnect(stream RelayMessage) returns (stream RelayMessage);
}

service BackendService {
  rpc RequestOrbUpdateConfig(config.OrbUpdateConfigRequest) returns (config.OrbUpdateConfigResponse);
}

message RelayMessage {
  Entity src = 1;
  Entity dst = 2;
  RelayPayload payload = 3;
}

message OrbConnectRequest {
  string orb_id = 1;
  string auth_token = 2;
}

message AppConnectRequest {
  string app_id = 1;
  string auth_token = 2;
}

message ConnectResponse {
  string client_id = 1;
  bool success = 2;
  string error = 3;
}

message Ping {
  optional string id = 1;
}

message Pong {
  optional string id = 1;
}

message RelayPayload {
  oneof payload {
    OrbConnectRequest orb_connect_request = 1;
    AppConnectRequest app_connect_request = 2;
    ConnectResponse connect_response = 3;
    Ping ping = 4;
    Pong pong = 5;

    // Config Payloads
    config.OrbReceiveConfigUpdate orb_receive_config_update = 6;
    config.OrbUpdateConfigRequest orb_update_config_request = 7;
    config.OrbUpdateConfigResponse orb_update_config_response = 8;

    // Self Serve Payloads
    selfserve.OrbStartSelfServeSignup orb_start_self_serve_signup = 9;
    selfserve.OrbSelfServeSessionStarted orb_self_serve_session_started = 10;
    selfserve.OrbSignupStarted orb_signup_started = 11;
    selfserve.OrbSignupCompleted orb_signup_completed = 12;
    selfserve.AppReceiveQR app_receive_qr = 13;
    selfserve.AppConnectedToOrb app_connected_to_orb = 14;
    selfserve.NotifyAppSignupStarted notify_app_signup_started = 15;
    selfserve.AppReceiveSignupResult app_receive_signup_result = 16;
    selfserve.AppShowStartSignupButton app_show_start_signup_button = 17;
    selfserve.AppRequestStartSelfServeFlow app_request_start_self_serve_flow = 18;
    selfserve.AppRequestStartSignup app_request_start_signup = 19;
  }
}
